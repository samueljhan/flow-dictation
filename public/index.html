<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Dictation - Medical Report Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: #2a2a2a;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 1000px;
            width: 100%;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #1f1f1f;
            color: #e0e0e0;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            border-bottom: 1px solid #3a3a3a;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.7;
            font-size: 14px;
        }

        .dictaphone-setup {
            padding: 15px 30px;
            background: #1f4a2e;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dictaphone-setup.connected {
            background: #1f3a2e;
        }

        .setup-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #a0e0b0;
        }

        .setup-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .setup-btn:hover {
            background: #218838;
        }

        .setup-btn.connected {
            background: #666;
        }

        .microphone-status {
            padding: 10px 30px;
            background: #242424;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #909090;
        }

        .mic-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .mic-indicator.connected {
            background: #28a745;
            animation: pulse-green 2s infinite;
        }

        .mic-indicator.recording {
            background: #dc3545;
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .specialty-selector {
            padding: 15px 30px;
            background: #242424;
            border-bottom: 1px solid #3a3a3a;
        }

        .specialty-selector label {
            font-weight: 400;
            color: #909090;
            margin-right: 12px;
            font-size: 13px;
        }

        .specialty-selector select {
            padding: 6px 12px;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            font-size: 13px;
            background: #2a2a2a;
            color: #909090;
            cursor: pointer;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #2a2a2a;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { flex-direction: row-reverse; }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .user .avatar { background: #404040; color: #e0e0e0; }
        .assistant .avatar { background: #353535; color: #b0b0b0; }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 15px;
            line-height: 1.6;
        }

        .user .message-content {
            background: #3a3a3a;
            color: #e0e0e0;
            border-radius: 15px 15px 0 15px;
        }

        .assistant .message-content {
            background: #333333;
            color: #d0d0d0;
            border: 1px solid #404040;
            border-radius: 15px 15px 15px 0;
        }

        .report-section { margin: 15px 0; }

        .report-section h3 {
            font-size: 14px;
            font-weight: 700;
            color: #909090;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .copy-btn {
            background: #404040;
            color: #e0e0e0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .copy-btn:hover { background: #505050; }
        .copy-btn.copied { background: #28a745; }

        .input-container {
            padding: 20px 30px;
            background: #242424;
            border-top: 1px solid #3a3a3a;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-wrapper { 
            flex: 1; 
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #userInput {
            flex: 1;
            padding: 0 20px;
            border: 1px solid #3a3a3a;
            border-radius: 25px;
            font-size: 15px;
            resize: none;
            font-family: inherit;
            height: 50px;
            line-height: 50px;
            background: #2a2a2a;
            color: #e0e0e0;
            overflow: hidden;
        }

        #userInput:focus { outline: none; border-color: #505050; }

        .voice-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .voice-btn:hover { 
            transform: scale(1.05);
        }

        .voice-btn.recording {
            animation: pulse-border 1.5s infinite;
        }

        .voice-btn svg {
            width: 50px;
            height: 50px;
        }

        .voice-btn .outer-circle {
            fill: #6B6B6B;
        }

        .voice-btn .inner-circle {
            fill: #2C2C2C;
        }

        .voice-btn .mic-elements {
            fill: #808080;
        }

        .voice-btn.recording .outer-circle {
            fill: #dc3545;
        }

        .voice-btn.recording .inner-circle {
            fill: #1a1a1a;
        }

        .voice-btn.recording .mic-elements {
            fill: #dc3545;
        }

        .voice-btn .rec-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            opacity: 0;
            border: 2px solid #242424;
        }

        .voice-btn.recording .rec-dot {
            opacity: 1;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-border { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.8; transform: scale(1.05); } 
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        #sendBtn {
            background: #404040;
            color: #e0e0e0;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            width: 50px;
            height: 50px;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sendBtn:hover { background: #505050; }

        .disclaimer {
            padding: 6px 30px;
            background: #242424;
            border-top: 1px solid #3a3a3a;
            color: #909090;
            font-size: 12px;
            text-align: center;
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: #909090;
        }

        .welcome-message h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #b0b0b0;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .example-prompt {
            background: #333333;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #404040;
            cursor: pointer;
            transition: all 0.3s;
        }

        .example-prompt:hover {
            border-color: #505050;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Flow Dictation</h1>
            <p>AI-Powered Medical Transcription with Dictaphone Support</p>
        </div>

        <div class="dictaphone-setup" id="dictaphoneSetup">
            <div class="setup-info">
                <span id="setupIcon">üé§</span>
                <span id="setupText">Connect your Philips dictaphone for hands-free recording</span>
            </div>
            <button class="setup-btn" id="setupBtn">Connect Dictaphone</button>
        </div>

        <div class="microphone-status">
            <div class="mic-indicator" id="micIndicator"></div>
            <span id="micStatus">Click microphone button to start</span>
        </div>

        <div class="specialty-selector">
            <label for="specialty">Specialty:</label>
            <select id="specialty">
                <option value="radiology">Radiology</option>
            </select>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <h2>Welcome to Flow Dictation! üëã</h2>
                <p>Real-time medical transcription powered by AssemblyAI</p>
                
                <div class="example-prompts">
                    <div class="example-prompt" onclick="useExample(this)">
                        <strong>ü´Å Chest X-Ray</strong>
                        <span>"Chest x-ray shows right lower lobe infiltrate with small pleural effusion"</span>
                    </div>
                    <div class="example-prompt" onclick="useExample(this)">
                        <strong>üß† Head CT</strong>
                        <span>"Head CT without contrast, 65 year old with headache, no acute findings"</span>
                    </div>
                    <div class="example-prompt" onclick="useExample(this)">
                        <strong>ü¶¥ Fracture Study</strong>
                        <span>"AP and lateral wrist showing distal radius fracture with dorsal angulation"</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea id="userInput" placeholder="Dictation appears here..." rows="1"></textarea>
                <button class="voice-btn" id="voiceBtn" title="Click to record or use dictaphone button">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- Outer gray ring -->
                        <circle cx="50" cy="50" r="48" class="outer-circle" stroke="#6B6B6B" stroke-width="4"/>
                        
                        <!-- Inner dark circle background -->
                        <circle cx="50" cy="50" r="44" class="inner-circle"/>
                        
                        <!-- Microphone capsule -->
                        <path class="mic-elements" d="M50 25 C50 25 50 25 50 25 C43 25 37 30 37 37 L37 47 C37 54 43 60 50 60 C57 60 63 54 63 47 L63 37 C63 30 57 25 50 25 Z"/>
                        
                        <!-- Microphone capsule inner -->
                        <ellipse cx="50" cy="40" rx="8" ry="12" class="mic-elements" opacity="0.5"/>
                        
                        <!-- Side handles -->
                        <ellipse cx="32" cy="45" rx="3" ry="5" class="mic-elements"/>
                        <ellipse cx="68" cy="45" rx="3" ry="5" class="mic-elements"/>
                        
                        <!-- Curved lines for sound indicator (arc shape) -->
                        <path class="mic-elements" d="M30 42 C30 42 30 47 30 47 C30 58 38 67 50 67 C62 67 70 58 70 47 L70 42" fill="none" stroke="#808080" stroke-width="3" stroke-linecap="round"/>
                        
                        <!-- Microphone stand -->
                        <line x1="50" y1="67" x2="50" y2="77" class="mic-elements" stroke="#808080" stroke-width="3" stroke-linecap="round"/>
                        <line x1="42" y1="77" x2="58" y2="77" class="mic-elements" stroke="#808080" stroke-width="3" stroke-linecap="round"/>
                        
                        <!-- Wave lines at bottom -->
                        <path class="mic-elements" d="M20 80 Q35 75 50 75 T80 80" fill="none" stroke="#808080" stroke-width="2.5" stroke-linecap="round"/>
                        <path class="mic-elements" d="M20 85 Q35 80 50 80 T80 85" fill="none" stroke="#808080" stroke-width="2.5" stroke-linecap="round"/>
                        <path class="mic-elements" d="M20 90 Q35 85 50 85 T80 90" fill="none" stroke="#808080" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                    <div class="rec-dot"></div>
                </button>
            </div>
            <button id="sendBtn" title="Generate report">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
            </button>
        </div>
        <div class="disclaimer">
            Not HIPAA compliant. Do not enter patient identifiers or PHI. Clinician review required.
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const micIndicator = document.getElementById('micIndicator');
        const micStatus = document.getElementById('micStatus');
        const setupBtn = document.getElementById('setupBtn');
        const setupText = document.getElementById('setupText');
        const setupIcon = document.getElementById('setupIcon');
        const dictaphoneSetup = document.getElementById('dictaphoneSetup');
        
        let ws = null;
        let audioContext = null;
        let mediaStream = null;
        let audioWorkletNode = null;
        let isRecording = false;
        let finalTranscript = '';
        let selectedMic = null;
        let hidDevice = null;
        let recordButton = null;

        const supportsHID = 'hid' in navigator;

        if (!supportsHID) {
            setupText.textContent = 'WebHID not supported - use Chrome/Edge or click mic button';
            setupBtn.style.display = 'none';
        }

        setupBtn.addEventListener('click', async () => {
            try {
                const devices = await navigator.hid.requestDevice({
                    filters: [
                        { vendorId: 0x0911 },
                        { vendorId: 0x095d }
                    ]
                });

                if (devices.length === 0) {
                    alert('No Philips dictaphone found. Make sure it is plugged in.');
                    return;
                }

                hidDevice = devices[0];
                await hidDevice.open();

                setupText.textContent = 'Connected: ' + hidDevice.productName;
                setupIcon.textContent = '‚úÖ';
                setupBtn.textContent = 'Connected';
                setupBtn.classList.add('connected');
                setupBtn.disabled = true;
                dictaphoneSetup.classList.add('connected');

                hidDevice.addEventListener('inputreport', handleDictaphoneButton);

                console.log('Dictaphone connected:', hidDevice.productName);
                micStatus.textContent = 'Press dictaphone button to record';

            } catch (error) {
                console.error('Error connecting dictaphone:', error);
                alert('Failed to connect dictaphone: ' + error.message);
            }
        });

        function handleDictaphoneButton(event) {
            const { data } = event;
            const value = data.getUint8(0);
            
            console.log('Dictaphone button event:', value);

            if (value !== 0x00 && !isRecording) {
                recordButton = value;
                startRecording();
            } else if (value === 0x00 && isRecording) {
                stopRecording();
            }
        }

        async function detectMicrophone() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                selectedMic = audioDevices.find(device => 
                    device.label.toLowerCase().includes('philips') ||
                    device.label.toLowerCase().includes('speechmike') ||
                    device.label.toLowerCase().includes('precision')
                ) || audioDevices[0];

                if (selectedMic) {
                    micIndicator.classList.add('connected');
                    micStatus.textContent = '‚úì ' + selectedMic.label;
                }
            } catch (error) {
                console.error('Error detecting microphone:', error);
            }
        }

        detectMicrophone();

        userInput.addEventListener('input', function() {
            this.style.height = '50px';
        });

        function useExample(element) {
            const text = element.querySelector('span').textContent.replace(/['"]/g, '');
            userInput.value = text;
            userInput.focus();
        }

        voiceBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                finalTranscript = userInput.value;
                startRecording();
            }
        });

        async function startRecording() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                ws = new WebSocket(protocol + '//' + window.location.host);
                
                ws.onopen = async () => {
                    const constraints = {
                        audio: {
                            deviceId: selectedMic ? { exact: selectedMic.deviceId } : undefined,
                            channelCount: 1,
                            sampleRate: 16000,
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                    const source = audioContext.createMediaStreamSource(mediaStream);
                    
                    const processorCode = 'class AudioProcessor extends AudioWorkletProcessor { process(inputs) { const input = inputs[0]; if (input.length > 0) { const samples = input[0]; const pcm = new Int16Array(samples.length); for (let i = 0; i < samples.length; i++) { pcm[i] = Math.max(-32768, Math.min(32767, samples[i] * 32768)); } this.port.postMessage(pcm.buffer); } return true; } } registerProcessor("audio-processor", AudioProcessor);';
                    
                    await audioContext.audioWorklet.addModule('data:text/javascript,' + encodeURIComponent(processorCode));
                    
                    audioWorkletNode = new AudioWorkletNode(audioContext, 'audio-processor');
                    audioWorkletNode.port.onmessage = (event) => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(event.data);
                        }
                    };
                    
                    source.connect(audioWorkletNode);
                    audioWorkletNode.connect(audioContext.destination);
                    
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    micIndicator.classList.add('recording');
                    micStatus.textContent = 'üî¥ Recording - Release to stop';
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'transcript') {
                        if (data.is_final) {
                            finalTranscript += (finalTranscript ? ' ' : '') + data.text;
                            userInput.value = finalTranscript;
                        } else {
                            userInput.value = finalTranscript + (finalTranscript ? ' ' : '') + data.text;
                        }
                    } else if (data.type === 'error') {
                        console.error('Transcription error:', data.message);
                        stopRecording();
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    stopRecording();
                };
                
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Could not start recording: ' + error.message);
            }
        }

        function stopRecording() {
            isRecording = false;
            voiceBtn.classList.remove('recording');
            micIndicator.classList.remove('recording');
            micStatus.textContent = hidDevice ? 'Press dictaphone button to record' : 'Click mic to record';
            
            if (audioWorkletNode) audioWorkletNode.disconnect();
            if (audioContext) audioContext.close();
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
            if (ws) ws.close();
            
            audioWorkletNode = null;
            audioContext = null;
            mediaStream = null;
            ws = null;
        }

        function addMessage(text, isUser) {
            const welcomeMsg = chatContainer.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'user' : 'assistant');
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = isUser ? 'Y' : 'FD';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function generateReport(findings) {
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ findings: findings, specialty: 'radiology' })
                });

                if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
                const data = await response.json();
                return formatReportHTML(data.report);
                
            } catch (error) {
                console.error('Error:', error);
                return '<p style="color: #ff6b6b;">‚ö†Ô∏è Error generating report.</p>';
            }
        }

        function formatReportHTML(reportText) {
            const sections = reportText.split('\n\n');
            let html = '';
            
            sections.forEach(section => {
                const lines = section.split('\n');
                const heading = lines[0];
                const content = lines.slice(1).join('\n');
                
                if (heading.match(/^[A-Z\s]+:?$/)) {
                    html += '<div class="report-section"><h3>' + heading.replace(':', '') + '</h3><p>' + content.trim() + '</p></div>';
                } else {
                    html += '<div class="report-section"><p>' + section + '</p></div>';
                }
            });
            
            html += '<button class="copy-btn" onclick="copyReport(this)">üìã Copy Report</button>';
            return html;
        }

        function copyReport(button) {
            const reportContent = button.parentElement;
            const sections = reportContent.querySelectorAll('.report-section');
            let textToCopy = '';
            
            sections.forEach(section => {
                const heading = section.querySelector('h3');
                const headingText = heading ? heading.textContent : '';
                const paragraphs = Array.from(section.querySelectorAll('p')).map(p => p.textContent).join('\n');
                if (headingText) {
                    textToCopy += headingText + ':\n' + paragraphs + '\n\n';
                } else {
                    textToCopy += paragraphs + '\n\n';
                }
            });

            navigator.clipboard.writeText(textToCopy).then(() => {
                button.textContent = '‚úÖ Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'üìã Copy Report';
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            
            userInput.value = '';
            finalTranscript = '';
            sendBtn.disabled = true;

            addMessage('Generating report...', false);

            generateReport(message).then(report => {
                const messages = chatContainer.querySelectorAll('.message');
                messages[messages.length - 1].remove();
                
                addMessage(report, false);
                sendBtn.disabled = false;
                userInput.focus();
            });
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>
